{% extends "base.html" %}
{% load crispy_forms_tags %}

{% block title %}Создать тендер{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card shadow-lg border-0">
                <div class="card-header bg-gradient-primary text-white text-center py-4">
                    <h3 class="mb-0">Создать новый тендер</h3>
                </div>

                <div class="card-body p-5">
                    <form method="post" id="tender-form" enctype="multipart/form-data">
                        {% csrf_token %}

                        <!-- Основная информация -->
                        <h5 class="text-primary mb-4">Основная информация</h5>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">{{ form.title|as_crispy_field }}</div>
                            <div class="col-md-6">{{ form.method|as_crispy_field }}</div>
                        </div>
                        <div class="row g-3 mb-4">
                            <div class="col-md-6">{{ form.start_date|as_crispy_field }}</div>
                            <div class="col-md-6">{{ form.end_date|as_crispy_field }}</div>
                        </div>
                        <div class="mb-4">{{ form.description|as_crispy_field }}</div>
                        <div class="mb-5">{{ form.budget|as_crispy_field }}</div>

                        <hr class="my-5">

                        <!-- Критерии -->
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <h5 class="text-primary mb-0">Критерии оценки</h5>
                            <div>
                                <small class="text-muted me-3">Сумма весов:</small>
                                <span id="total-weight-display" class="badge bg-danger fs-6">0.0000</span>
                                <span class="text-success ms-2">должна быть 1.0000</span>
                            </div>
                        </div>

                        <div id="criteria-container">
                            {{ criteria_formset.management_form }}

                            {% for form in criteria_formset %}
                                <div class="criterion-item border rounded p-4 mb-3 bg-light position-relative">

                                    <!-- Скрытые поля -->
                                    {% if form.instance.pk %}{{ form.id }}{% endif %}
                                    {{ form.DELETE }}

                                    <div class="row g-3 align-items-end">
                                        <div class="col-md-7">
                                            {{ form.criterion|as_crispy_field }}
                                        </div>
                                        <div class="col-md-4">
                                            {{ form.weight|as_crispy_field }}
                                        </div>
                                        <div class="col-md-1">
                                            <button type="button" class="btn btn-danger btn-sm remove-criterion">
                                                Удалить
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <button type="button" id="add-criterion" class="btn btn-outline-primary">
                                + Добавить критерий
                            </button>

                            <div id="weight-error" class="alert alert-danger d-none">
                                <strong>Ошибка!</strong> Сумма весов должна быть ровно <strong>1.0000</strong><br>
                                Сейчас: <span id="current-sum">0</span>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-3 mt-5">
                            <a href="{% url 'tender_list' %}" class="btn btn-secondary btn-lg">Отмена</a>
                            <button type="submit" class="btn btn-success btn-lg px-5">Создать тендер</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Пустая форма-шаблон для клонирования -->
<template id="empty-criterion-template">
    <div class="criterion-item border rounded p-4 mb-3 bg-light position-relative">
        <div class="row g-3 align-items-end">
            <div class="col-md-7">
                <div class="form-group">
                    <label class="form-label">Критерий</label>
                    <select name="criteria-__prefix__-criterion" class="form-select" required id="id_criteria-__prefix__-criterion">
                        <option value="">---------</option>
                        {% for crit in criteria_formset.forms.0.criterion.field.queryset %}
                            <option value="{{ crit.id }}">{{ crit.name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div class="col-md-4">
                <div class="form-group">
                    <label class="form-label">Вес (0.00–1.00)</label>
                    <input type="number" name="criteria-__prefix__-weight" step="0.01" min="0" max="1" class="form-control" id="id_criteria-__prefix__-weight">
                </div>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-danger btn-sm remove-criterion">Удалить</button>
            </div>
        </div>
    </div>
</template>

<script>
document.addEventListener('DOMContentLoaded', function () {
    const container = document.getElementById('criteria-container');
    const totalForms = document.querySelector('#id_criteria-TOTAL_FORMS');
    const addButton = document.getElementById('add-criterion');
    const template = document.getElementById('empty-criterion-template').content;
    const errorDiv = document.getElementById('weight-error');
    const currentSumSpan = document.getElementById('current-sum');
    const totalDisplay = document.getElementById('total-weight-display');

    function updateTotalWeight() {
        let total = 0;
        document.querySelectorAll('input[name*="weight"]').forEach(input => {
            total += parseFloat(input.value) || 0;
        });
        totalDisplay.textContent = total.toFixed(4);
        totalDisplay.className = 'badge fs-6 ' + (Math.abs(total - 1.0) < 0.001 ? 'bg-success' : 'bg-danger');
        return total;
    }

    addButton.addEventListener('click', function () {
        const formCount = parseInt(totalForms.value);
        const newForm = template.cloneNode(true);

        // Заменяем __prefix__ на текущий индекс
        newForm.querySelectorAll('[name], [id]').forEach(el => {
            if (el.name) el.name = el.name.replace('__prefix__', formCount);
            if (el.id) el.id = el.id.replace('__prefix__', formCount);
        });

        container.appendChild(newForm);
        totalForms.value = formCount + 1;
        updateTotalWeight();
    });

    container.addEventListener('click', function (e) {
        const btn = e.target.closest('.remove-criterion');
        if (btn && container.querySelectorAll('.criterion-item').length > 1) {
            btn.closest('.criterion-item').remove();
            updateTotalWeight();
        }
    });

    container.addEventListener('input', updateTotalWeight);

    document.getElementById('tender-form').addEventListener('submit', function (e) {
        const total = updateTotalWeight();
        if (Math.abs(total - 1.0) > 0.001) {
            e.preventDefault();
            errorDiv.classList.remove('d-none');
            currentSumSpan.textContent = total.toFixed(4);
            errorDiv.scrollIntoView({behavior: 'smooth'});
        }
    });

    // Инициализация
    updateTotalWeight();
});
</script>

<style>
    .bg-gradient-primary { background: linear-gradient(135deg, #4361ee, #3f37c9) !important; }
    #total-weight-display { font-size: 1.2rem; min-width: 90px; text-align: center; }
</style>
{% endblock %}