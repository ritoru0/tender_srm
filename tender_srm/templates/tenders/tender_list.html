{% extends "base.html" %}
{% load humanize %}

{% block title %}Список тендеров{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Тендеры</h1>
        {% if user.role == 'Фирма' and user.organization.verification_status == 'Подтверждено' %}
        <a href="{% url 'create_tender' %}" class="btn btn-primary">
            <i class="fas fa-plus"></i> Создать тендер
        </a>
        {% endif %}
    </div>

    <!-- Мои тендеры (для фирм) -->
    {% if my_tenders %}
    <div class="mb-5">
        <h3 class="mb-3">Мои тендеры</h3>
        <div class="row">
            {% for tender in my_tenders %}
            <div class="col-md-6 mb-3">
                <div class="card h-100 shadow-sm">
                    <div class="card-header bg-light">
                        <h5 class="card-title mb-0">{{ tender.title }}</h5>
                    </div>
                    <div class="card-body">
                        {% if tender.description %}
                        <p class="card-text">{{ tender.description|truncatewords:20 }}</p>
                        {% endif %}
                        <div class="tender-info">
                            <p class="mb-1"><strong>Бюджет:</strong> {{ tender.budget|intcomma }} ₽</p>
                            <p class="mb-1"><strong>Статус:</strong> 
                                <span class="badge {% if tender.status == 'Открыт' %}bg-success{% elif tender.status == 'В оценке' %}bg-warning{% else %}bg-secondary{% endif %}">
                                    {{ tender.get_status_display }}
                                </span>
                            </p>
                            <p class="mb-1"><strong>Метод:</strong> {{ tender.get_method_display }}</p>
                            <p class="mb-0"><strong>Срок:</strong> до {{ tender.end_date }}</p>
                        </div>
                    </div>
                    <div class="card-footer">
                        <a href="{% url 'tender_detail' tender.id %}" class="btn btn-sm btn-outline-primary">
                            <i class="fas fa-eye"></i> Подробнее
                        </a>
                        {% if tender.status == 'Открыт' %}
                        <span class="badge bg-success ms-2">Активен</span>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Все тендеры -->
    <div>
        <h3 class="mb-3">
            {% if my_tenders %}Доступные тендеры{% else %}Все тендеры{% endif %}
        </h3>
        
        {% if other_tenders %}
            <!-- Если есть разделение на мои и другие тендеры -->
            <div class="row">
                {% for tender in other_tenders %}
                <div class="col-md-6 mb-3">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h5 class="card-title mb-0">{{ tender.title }}</h5>
                        </div>
                        <div class="card-body">
                            {% if tender.description %}
                            <p class="card-text">{{ tender.description|truncatewords:20 }}</p>
                            {% endif %}
                            <div class="tender-info">
                                <p class="mb-1"><strong>Организатор:</strong> {{ tender.organization.name }}</p>
                                <p class="mb-1"><strong>Бюджет:</strong> {{ tender.budget|intcomma }} ₽</p>
                                <p class="mb-1"><strong>Метод:</strong> {{ tender.get_method_display }}</p>
                                <p class="mb-0"><strong>Срок подачи:</strong> до {{ tender.end_date }}</p>
                            </div>
                        </div>
                        <div class="card-footer">
                            <a href="{% url 'tender_detail' tender.id %}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i> Подробнее
                            </a>
                            {% if user.role == 'Поставщик' and user.organization.verification_status == 'Подтверждено' and tender.status == 'Открыт' %}
                            <a href="{% url 'create_proposal' tender.id %}" class="btn btn-sm btn-success">
                                <i class="fas fa-paper-plane"></i> Подать заявку
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% elif tenders %}
            <div class="row">
                {% for tender in tenders %}
                <div class="col-md-6 mb-3">
                    <div class="card h-100 shadow-sm">
                        <div class="card-header {% if tender.organization == user.organization %}bg-light{% else %}bg-primary text-white{% endif %}">
                            <h5 class="card-title mb-0">{{ tender.title }}</h5>
                        </div>
                        <div class="card-body">
                            {% if tender.description %}
                            <p class="card-text">{{ tender.description|truncatewords:20 }}</p>
                            {% endif %}
                            <div class="tender-info">
                                <p class="mb-1"><strong>Организатор:</strong> {{ tender.organization.name }}</p>
                                <p class="mb-1"><strong>Бюджет:</strong> {{ tender.budget|intcomma }} ₽</p>
                                <p class="mb-1"><strong>Статус:</strong> 
                                    <span class="badge {% if tender.status == 'Открыт' %}bg-success{% elif tender.status == 'В оценке' %}bg-warning{% else %}bg-secondary{% endif %}">
                                        {{ tender.get_status_display }}
                                    </span>
                                </p>
                                <p class="mb-0"><strong>Срок подачи:</strong> до {{ tender.end_date }}</p>
                            </div>
                        </div>
                        <div class="card-footer">
                            <a href="{% url 'tender_detail' tender.id %}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-eye"></i> Подробнее
                            </a>
                            {% if user.role == 'Поставщик' and user.organization.verification_status == 'Подтверждено' and tender.status == 'Открыт' and tender.organization != user.organization %}
                            <a href="{% url 'create_proposal' tender.id %}" class="btn btn-sm btn-success">
                                <i class="fas fa-paper-plane"></i> Подать заявку
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <!-- Если нет тендеров -->
            <div class="alert alert-info">
                <h5 class="alert-heading">Нет доступных тендеров</h5>
                <p class="mb-0">В настоящее время нет активных тендеров. Возвращайтесь позже или создайте свой тендер.</p>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}